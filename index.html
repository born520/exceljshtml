<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to HTML 변환기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .drop-area.active {
            border-color: #0d6efd;
            background-color: #e9f0ff;
        }
        .preview-container {
            margin-top: 30px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
        }
        .sheet-tabs {
            display: flex;
            margin-bottom: 15px;
            overflow-x: auto;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .sheet-tab {
            padding: 8px 15px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }
        .sheet-tab.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .sheet-content {
            display: none;
        }
        .sheet-content.active {
            display: block;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #download-all-btn {
            display: none;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1 class="mb-4">Excel to HTML 변환기</h1>
    <p class="lead">Excel 파일을 업로드하면 HTML로 변환하여 미리보기를 보여줍니다. 서식과 이미지가 포함됩니다.</p>
    
    <div class="drop-area" id="drop-area">
        <p>Excel 파일을 여기에 끌어다 놓거나 클릭하여 선택하세요</p>
        <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">파일 선택</button>
    </div>
    
    <div class="loading" id="loading">
        <div class="loader"></div>
        <p>파일 처리 중...</p>
    </div>
    
    <div class="preview-container" id="preview-container" style="display: none;">
        <h2>변환 결과</h2>
        <div class="sheet-tabs" id="sheet-tabs"></div>
        <div class="sheet-contents" id="sheet-contents"></div>
        <button class="btn btn-success" id="download-all-btn">모든 시트 HTML 다운로드</button>
    </div>

    <!-- ExcelJS 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script>
        // 전역 변수
        let workbook = null;
        let generatedHtml = {};

        // DOM 요소
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const loading = document.getElementById('loading');
        const previewContainer = document.getElementById('preview-container');
        const sheetTabs = document.getElementById('sheet-tabs');
        const sheetContents = document.getElementById('sheet-contents');
        const downloadAllBtn = document.getElementById('download-all-btn');

        // 드래그 앤 드롭 이벤트 핸들링
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('active');
        }

        function unhighlight() {
            dropArea.classList.remove('active');
        }

        // 파일 드롭 처리
        dropArea.addEventListener('drop', handleDrop, false);
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // 파일 입력 처리
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        // 파일 처리
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    processExcelFile(file);
                } else {
                    alert('Excel 파일(.xlsx 또는 .xls)만 업로드 가능합니다.');
                }
            }
        }

        // Excel 파일 처리
        async function processExcelFile(file) {
            try {
                // 로딩 상태 표시
                loading.style.display = 'block';
                dropArea.style.display = 'none';
                previewContainer.style.display = 'none';
                
                // ExcelJS를 사용하여 파일 로드
                workbook = new ExcelJS.Workbook();
                const arrayBuffer = await file.arrayBuffer();
                await workbook.xlsx.load(arrayBuffer);
                
                // 시트 탭과 내용 생성
                sheetTabs.innerHTML = '';
                sheetContents.innerHTML = '';
                generatedHtml = {};
                
                let isFirst = true;
                workbook.eachSheet((sheet, sheetId) => {
                    const sheetName = sheet.name;
                    const safeName = sheetName.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    // 탭 생성
                    const tab = document.createElement('div');
                    tab.className = `sheet-tab${isFirst ? ' active' : ''}`;
                    tab.innerText = sheetName;
                    tab.onclick = function() { showSheet(safeName); };
                    sheetTabs.appendChild(tab);
                    
                    // 시트 내용 생성
                    const content = document.createElement('div');
                    content.className = `sheet-content${isFirst ? ' active' : ''}`;
                    content.id = safeName;
                    
                    // 시트를 HTML로 변환
                    const sheetHtml = convertSheetToHtml(sheet);
                    content.innerHTML = sheetHtml;
                    sheetContents.appendChild(content);
                    
                    // 생성된 HTML 저장
                    generatedHtml[safeName] = {
                        name: sheetName,
                        html: sheetHtml
                    };
                    
                    isFirst = false;
                });
                
                // 다운로드 버튼 표시
                downloadAllBtn.style.display = 'block';
                downloadAllBtn.onclick = downloadAllSheets;
                
                // 결과 표시
                previewContainer.style.display = 'block';
            } catch (error) {
                console.error('Excel 처리 중 오류 발생:', error);
                alert('파일 처리 중 오류가 발생했습니다: ' + error.message);
            } finally {
                loading.style.display = 'none';
                dropArea.style.display = 'block';
            }
        }

        // 시트를 HTML로 변환
        function convertSheetToHtml(sheet) {
            let html = '<table>';
            
            // 열 너비 정보 저장
            const columnWidths = {};
            sheet.columns.forEach((column, index) => {
                if (column.width) {
                    columnWidths[index + 1] = column.width;
                }
            });
            
            // 병합 셀 정보 추출
            const mergedCells = {};
            if (sheet.model && sheet.model.merges) {
                for (const mergeAddress of Object.keys(sheet.model.merges)) {
                    const decoded = decodeRef(mergeAddress);
                    if (decoded) {
                        for (let r = decoded.top; r <= decoded.bottom; r++) {
                            for (let c = decoded.left; c <= decoded.right; c++) {
                                mergedCells[`${r},${c}`] = {
                                    top: decoded.top,
                                    left: decoded.left,
                                    rowspan: decoded.bottom - decoded.top + 1,
                                    colspan: decoded.right - decoded.left + 1
                                };
                            }
                        }
                    }
                }
            }
            
            // 이미지 정보 추출
            const images = [];
            if (sheet.model && sheet.model.media) {
                for (const mediaKey of Object.keys(sheet.model.media)) {
                    const media = sheet.model.media[mediaKey];
                    if (media.type === 'image') {
                        try {
                            const imageId = media.index;
                            const image = workbook.model.media.find(m => m.index === imageId);
                            
                            if (image) {
                                // 이미지 위치 정보
                                const range = decodeRef(mediaKey);
                                
                                // 이미지 데이터를 Base64로 변환
                                const base64 = arrayBufferToBase64(image.buffer);
                                const contentType = image.extension === 'png' ? 'image/png' : 
                                                    image.extension === 'jpg' || image.extension === 'jpeg' ? 'image/jpeg' : 
                                                    'image/gif';
                                const dataUrl = `data:${contentType};base64,${base64}`;
                                
                                images.push({
                                    row: range.top,
                                    col: range.left,
                                    dataUrl: dataUrl,
                                    width: media.width || 100,
                                    height: media.height || 100
                                });
                            }
                        } catch (e) {
                            console.warn('이미지 처리 중 오류:', e);
                        }
                    }
                }
            }
            
            // 행과 셀 처리
            let rowNum = 1;
            sheet.eachRow({ includeEmpty: true }, (row, rowNum) => {
                html += '<tr>';
                
                // 각 셀 처리
                row.eachCell({ includeEmpty: true }, (cell, colNum) => {
                    const cellKey = `${rowNum},${colNum}`;
                    
                    // 병합된 셀인 경우 처리
                    if (mergedCells[cellKey]) {
                        // 병합된 셀의 시작 부분인 경우만 처리
                        if (mergedCells[cellKey].top === rowNum && mergedCells[cellKey].left === colNum) {
                            const style = getCellStyle(cell, columnWidths[colNum]);
                            const value = getCellValue(cell);
                            html += `<td rowspan="${mergedCells[cellKey].rowspan}" colspan="${mergedCells[cellKey].colspan}" style="${style}">${value}</td>`;
                        }
                        // 그 외 병합된 셀 부분은 건너뜁니다
                    } else {
                        const style = getCellStyle(cell, columnWidths[colNum]);
                        const value = getCellValue(cell);
                        html += `<td style="${style}">${value}</td>`;
                    }
                });
                
                html += '</tr>';
                rowNum++;
            });
            
            html += '</table>';
            
            // 이미지 추가
            if (images.length > 0) {
                // 이미지 컨테이너 추가
                html += '<div class="image-container" style="position: relative;">';
                
                images.forEach(img => {
                    // 대략적인 위치 계산 (정확한 위치는 Excel 파일에 따라 다를 수 있음)
                    const top = (img.row - 1) * 20; // 행 높이를 20px로 가정
                    const left = (img.col - 1) * 100; // 열 너비를 100px로 가정
                    
                    html += `<img src="${img.dataUrl}" style="position: absolute; top: ${top}px; left: ${left}px; width: ${img.width}px; height: ${img.height}px;">`;
                });
                
                html += '</div>';
            }
            
            return html;
        }

        // 셀 스타일 생성
        function getCellStyle(cell, columnWidth) {
            const style = [];
            
            if (cell.style) {
                // 배경색
                if (cell.style.fill && cell.style.fill.type === 'pattern' && cell.style.fill.pattern === 'solid') {
                    const bgColor = cell.style.fill.fgColor || {};
                    if (bgColor.argb) {
                        // ARGB 형식에서 RGB 형식으로 변환
                        const rgb = argbToRgb(bgColor.argb);
                        style.push(`background-color: ${rgb}`);
                    }
                }
                
                // 글꼴
                if (cell.style.font) {
                    // 글꼴 색상
                    if (cell.style.font.color && cell.style.font.color.argb) {
                        const rgb = argbToRgb(cell.style.font.color.argb);
                        style.push(`color: ${rgb}`);
                    }
                    
                    // 글꼴 크기
                    if (cell.style.font.size) {
                        style.push(`font-size: ${cell.style.font.size}pt`);
                    }
                    
                    // 글꼴 굵기
                    if (cell.style.font.bold) {
                        style.push('font-weight: bold');
                    }
                    
                    // 기울임체
                    if (cell.style.font.italic) {
                        style.push('font-style: italic');
                    }
                    
                    // 밑줄
                    if (cell.style.font.underline) {
                        style.push('text-decoration: underline');
                    }
                }
                
                // 정렬
                if (cell.style.alignment) {
                    // 가로 정렬
                    if (cell.style.alignment.horizontal) {
                        style.push(`text-align: ${cell.style.alignment.horizontal}`);
                    }
                    
                    // 세로 정렬
                    if (cell.style.alignment.vertical) {
                        const vAlign = cell.style.alignment.vertical === 'middle' ? 'middle' : 
                                      cell.style.alignment.vertical === 'top' ? 'top' : 'bottom';
                        style.push(`vertical-align: ${vAlign}`);
                    }
                    
                    // 텍스트 줄바꿈
                    if (cell.style.alignment.wrapText) {
                        style.push('white-space: pre-wrap');
                    }
                }
                
                // 테두리
                ['top', 'right', 'bottom', 'left'].forEach(side => {
                    const border = cell.style.border && cell.style.border[side];
                    if (border && border.style && border.style !== 'none') {
                        const borderColor = border.color && border.color.argb ? argbToRgb(border.color.argb) : '#000000';
                        style.push(`border-${side}: 1px ${border.style} ${borderColor}`);
                    }
                });
            }
            
            // 열 너비 (있는 경우)
            if (columnWidth) {
                style.push(`width: ${columnWidth}px`);
            }
            
            // 기본 스타일
            style.push('padding: 4px');
            
            return style.join('; ');
        }

        // 셀 값 가져오기
        function getCellValue(cell) {
            if (!cell || cell.value === null || cell.value === undefined) {
                return '&nbsp;';
            }
            
            // 수식 결과
            if (cell.formula) {
                return cell.result || '';
            }
            
            // 링크 처리
            if (cell.hyperlink) {
                return `<a href="${cell.hyperlink}" target="_blank">${escapeHtml(cell.text || cell.value)}</a>`;
            }
            
            // 날짜 처리
            if (cell.value instanceof Date) {
                return cell.value.toLocaleDateString();
            }
            
            // 리치 텍스트 처리
            if (cell.value && cell.value.richText) {
                // 리치 텍스트는 복잡하므로 간단하게 텍스트만 추출
                let text = '';
                cell.value.richText.forEach(part => {
                    text += part.text;
                });
                return escapeHtml(text);
            }
            
            // 일반 텍스트 (줄바꿈 처리)
            if (typeof cell.value === 'string') {
                return escapeHtml(cell.value).replace(/\n/g, '<br>');
            }
            
            // 기타 값
            return escapeHtml(String(cell.value));
        }

        // ARGB 색상 코드를 RGB 색상 코드로 변환
        function argbToRgb(argb) {
            if (!argb || argb.length !== 8) {
                return '#000000';
            }
            return '#' + argb.substring(2);
        }

        // ArrayBuffer를 Base64 문자열로 변환
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // Excel 참조 디코드 (예: A1:B2 → {top: 1, left: 1, bottom: 2, right: 2})
        function decodeRef(ref) {
            // 단일 셀 참조 (예: A1)
            const singleCellMatch = ref.match(/^([A-Z]+)(\d+)$/);
            if (singleCellMatch) {
                const col = columnNameToNumber(singleCellMatch[1]);
                const row = parseInt(singleCellMatch[2]);
                return { top: row, left: col, bottom: row, right: col };
            }
            
            // 범위 참조 (예: A1:B2)
            const rangeMatch = ref.match(/^([A-Z]+)(\d+):([A-Z]+)(\d+)$/);
            if (rangeMatch) {
                const col1 = columnNameToNumber(rangeMatch[1]);
                const row1 = parseInt(rangeMatch[2]);
                const col2 = columnNameToNumber(rangeMatch[3]);
                const row2 = parseInt(rangeMatch[4]);
                
                return {
                    top: Math.min(row1, row2),
                    left: Math.min(col1, col2),
                    bottom: Math.max(row1, row2),
                    right: Math.max(col1, col2)
                };
            }
            
            return null;
        }

        // 열 이름을 숫자로 변환 (예: A → 1, Z → 26, AA → 27)
        function columnNameToNumber(name) {
            let num = 0;
            const len = name.length;
            for (let i = 0; i < len; i++) {
                num = num * 26 + (name.charCodeAt(i) - 64);
            }
            return num;
        }

        // 시트 탭 처리
        function showSheet(sheetName) {
            // 모든 탭과 내용 비활성화
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.sheet-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 선택한 탭과 내용 활성화
            document.querySelector(`.sheet-tab:nth-child(${Array.from(document.querySelectorAll('.sheet-tab')).findIndex(tab => tab.innerText === generatedHtml[sheetName].name) + 1})`).classList.add('active');
            document.getElementById(sheetName).classList.add('active');
        }

        // 모든 시트 다운로드
        function downloadAllSheets() {
            // HTML 전체 템플릿
            const htmlTemplate = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Excel 변환 결과</title>
    <style>
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            border-right: 1px solid #ddd;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #4285f4;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .tabcontent.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel 변환 결과</h1>
        
        <div class="tab" id="sheetTabs">
            ${Object.values(generatedHtml).map((sheet, index) => 
                `<button class="tablinks ${index === 0 ? 'active' : ''}" onclick="openSheet(event, '${sheet.name.replace(/[^a-zA-Z0-9]/g, '_')}')">${sheet.name}</button>`
            ).join('')}
        </div>
        
        ${Object.values(generatedHtml).map((sheet, index) => 
            `<div id="${sheet.name.replace(/[^a-zA-Z0-9]/g, '_')}" class="tabcontent ${index === 0 ? 'active' : ''}">
                <h2>${sheet.name}</h2>
                ${sheet.html}
            </div>`
        ).join('')}
    </div>
    
    <script>
    function openSheet(evt, sheetName) {
        var i, tabcontent, tablinks;
        
        // 모든 탭 내용 숨기기
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        
        // 모든 탭 버튼 비활성화
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        
        // 선택한 탭 활성화
        document.getElementById(sheetName).style.display = "block";
        document.getElementById(sheetName).classList.add("active");
        evt.currentTarget.className += " active";
    }
    </script>
</body>
</html>`;
            
            // HTML 파일 다운로드
            const blob = new Blob([htmlTemplate], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'excel-to-html.html';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // HTML 이스케이프 함수
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                return String(text);
            }
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>